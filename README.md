# shem
Self-hosted, secure, trustworthy, FOSS, email server automatic installation, configuration, and deployment script with makefile for backend admin and maintenance tasks

This script automates the setup and configuration of an email server on a fresh Ubuntu 24.04 VPS. It includes the installation and configuration of Postfix, Dovecot, OpenDKIM, SpamAssassin, ClamAV, and SSL/TLS certificates using Let's Encrypt. The script also configures the necessary firewall rules using UFW and sets up Roundcube as the webmail front-end.

## Prerequisites

- A fresh Ubuntu 24.04 server
- A domain name (e.g., mycooldomain.com)
- Update MySQL root password and Postfix MySQL password in the script

## Usage

1. Make the script executable:
    ```sh
    chmod +x setup_email_server.sh
    ```

2. Run the script:
    ```sh
    sudo ./setup_email_server.sh
    ```

3. Use the provided Makefile for maintenance tasks:
    ```sh
    make help
    ```

## Makefile Commands

- `make update`: Update and upgrade the system packages.
- `make create_user USER=username DOMAIN=domain.com PASSWORD=password`: Create a new virtual email user.
- `make alias ALIAS=alias@domain.com REAL_EMAIL=real@domain.com`: Create an alias for an existing email.
- `make reset_password USER=username DOMAIN=domain.com PASSWORD=password`: Reset password for a virtual email user.
- `make make_script_executable`: Make the setup script executable.
- `make run_script`: Execute the setup script with sudo privileges.
- `make learn_spam PATH=path/to/spam`: Teach SpamAssassin to learn spam from given path.
- `make learn_ham PATH=path/to/ham`: Teach SpamAssassin to learn ham from given path.
- `make unlearn_spam PATH=path/to/spam`: Unteach SpamAssassin to unlearn spam from given path.
- `make unlearn_ham PATH=path/to/ham`: Unteach SpamAssassin to unlearn ham from given path.

## DNS Configuration

### MX Records

Ensure you have an MX record pointing to your mail server:

@   IN  MX  10  mail.mycooldomain.com.

### DKIM Records

Add a DKIM TXT record to your DNS settings. The content for the DKIM TXT record is generated by the `opendkim-genkey` command in the setup script. The command output will show the required content, which usually looks like this:

'''
mail._domainkey.mycooldomain.com. IN  TXT  "v=DKIM1; k=rsa; p=<YourPublicKeyHere>"
'''

Replace `<YourPublicKeyHere>` with the actual public key from the generated key file (e.g., `/etc/opendkim/keys/mail.txt`).

### SPF Records

Add an SPF TXT record to your DNS settings:

@   IN  TXT  "v=spf1 mx a include:_spf.google.com ~all"

This example allows the domain to send emails through its own MX server, any server specified by `a`, and Googleâ€™s servers.

## Additional Manual Configuration

- **Roundcube**: After the script is executed, ensure that Roundcube is configured with your database details by following the onscreen instructions during the setup process. Adjust Roundcube configurations in `/etc/roundcube/config.inc.php` as needed for your specific requirements.
- **MX and TXT Records**: Ensure that your DNS provider is updated with the correct MX, SPF, and DKIM records as mentioned above.
- **Starting and Enabling Services**: The script restarts and enables necessary services. Ensure they are running correctly using `systemctl status postfix`, `systemctl status dovecot`, and `systemctl status nginx`.
